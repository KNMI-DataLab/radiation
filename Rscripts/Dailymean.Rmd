---
title: "DailyMean Satellite data"
author: "Marieke"
date: "September, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
.libPaths("/usr/people/dirksen/R-20160725/x86_64-redhat-linux-gnu-library/3.3/")
library(rhdf5)
library(raster)
library(maptools)
library(rgdal)
data(wrld_simpl)
```

```{r}
#Daily mean radiation from satellite
pathsat<-"/net/pc150398/nobackup_1/users/meirink/siccs_wouter/SICCS/daymean/"
loc.grid<-"/net/pc150398/nobackup/users/meirink/msg_archive/geo/meteosat9.euro4m.angles.h5"
year.sat<-seq(from=2004,to=2016,by=1)
Y<-year.sat[11]

pathsat.year<-paste0(pathsat,Y)

#selecting a test month
m<-"07"
files.sat<-list.files(path=paste0(pathsat.year,"/",m))
```

```{r}
setwd(paste0(pathsat.year,"/","07"))

file<-files.sat[1]
d<-gsub("daymean","",file)
d<-gsub("EURO4M.hdf5","",d)
time<-as.POSIXct(paste0(Y,"-",m,"-",d))

#structure of the file
h5ls(file)
data.direct.irradiance<-h5read(file,"direct irradiance")
data.diffuse.irradiance<-h5read(file,"diffuse irradiance")
data.total.irradiance<-data.direct.irradiance+data.diffuse.irradiance
data.total.irradiance<-t(data.total.irradiance)
#the grid file
h5ls(loc.grid)
data.lat<-h5read(loc.grid,"/lat") #Latitude
data.lon<-h5read(loc.grid,"/lon") #Longitude

data.lat[which(data.lat==-999)]<-NA # replace no data value with NA (this case -1)
data.lon[which(data.lon==-999)]<-NA # replace no data value with NA (this case -1)

r<-raster(data.total.irradiance,crs=CRS("+init=epsg:4326"),
      xmn=min(data.lon,na.rm=T),
      xmx=max(data.lon,na.rm=T),
      ymn=min(data.lat,na.rm=T),
      ymx=max(data.lat,na.rm=T))
plot(r,main=paste("Datum=",time))
plot(wrld_simpl,add=TRUE)
```

#Reprojecting raster and comparing with observations
```{r}
pro=CRS("+init=epsg:28992")

#Natural Earth dataset: unprojected shape files
mymap.unpro=readOGR(dsn='/run/media/dirksen/Elements/Final_R_scripts/NaturalEarthData/ne_10m_admin_0_countries',layer="ne_10m_admin_0_countries") # Read in (unprojected) map data
mymap.pro=spTransform(mymap.unpro, pro) # Reproject the map

mymap.unpro_lakes=readOGR(dsn='/run/media/dirksen/Elements/Final_R_scripts/NaturalEarthData/ne_10m_lakes',layer="ne_10m_lakes") # Read in (unprojected) map data
mymap.pro_lakes=spTransform(mymap.unpro_lakes, pro) # Reproject the map

r<-projectRaster(r,crs=pro)
r.NED<-crop(r,extent(12621.630033977,278621.630033977,305583.0457758,620583.0457758))

plot(r.NED,main=paste("Datum=",time))
plot(mymap.pro,add=TRUE)
plot(mymap.pro_lakes,add=TRUE)
```